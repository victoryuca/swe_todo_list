Código refactorizado, sólo faltan las pruebas.
